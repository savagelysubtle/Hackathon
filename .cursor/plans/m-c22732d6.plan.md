<!-- c22732d6-38aa-4942-aa4c-333c109aea51 645813dc-b2c0-423c-9404-e47544d50418 -->
# MCP Tools Integration Plan

## Overview

Add MCP (Model Context Protocol) tool support to the Pydantic AI agent, enabling dynamic loading of external tools through a configuration file. This will include a settings page in the frontend and backend integration for loading MCP servers.

## Architecture

### Frontend Components (Next.js/React)

- **Settings Page** (`src/app/settings/page.tsx`): UI for viewing and editing MCP configurations
- **MCP Config API** (`src/app/api/mcp/route.ts`): REST endpoints for CRUD operations on mcp.json
- **Types** (`src/lib/types.ts`): TypeScript interfaces for MCP configuration

### Backend Integration (Pydantic AI)

- **MCP Loader** (`agent/src/mcp_loader.py`): Module to load and initialize MCP servers
- **Agent Configuration** (`agent/src/agent.py`): Update agent to include MCP tools
- **Configuration File** (`data/mcp.json`): Storage for MCP server configurations

## Implementation Steps

### 1. Create Data Structure & Types

**Backend: `data/mcp.json` (Initial Configuration)**

```json
{
  "mcpServers": {
    "example-python": {
      "command": "deno",
      "args": [
        "run",
        "-A",
        "https://jsr.io/@pydantic/mcp-run-python@latest"
      ],
      "enabled": true,
      "description": "Execute Python code in a sandboxed environment"
    }
  }
}
```

**Frontend Types: `src/lib/types.ts`**

- Add `MCPServerConfig` interface
- Add `MCPConfiguration` interface
- Export types for API routes

### 2. Create MCP Loader Module (Python)

**File: `agent/src/mcp_loader.py`**

- Implement `load_mcp_config()`: Read and parse mcp.json
- Implement `initialize_mcp_servers()`: Create MCP server connections
- Handle errors gracefully (missing files, invalid configs)
- Support for different server types (stdio, command-based)
- Filter by `enabled` flag

### 3. Update Agent with MCP Tools

**File: `agent/src/agent.py`**

- Import MCP loader module
- Load MCP servers at agent initialization
- Add MCP tools to agent's toolset
- Maintain existing tools (get_proverbs, add_proverbs, etc.)

**File: `agent/pyproject.toml`**

- Add `pydantic-ai-slim[mcp]` dependency
- Add any required MCP server packages

### 4. Create Settings Page UI

**File: `src/app/settings/page.tsx`**

- Display list of configured MCP servers
- Show server details (command, args, status)
- Enable/disable toggle for each server
- Add new server form
- Edit existing server configurations
- Delete server configurations
- Test connection button
- Save/cancel actions

**Styling:**

- Match existing theme system (themeColor support)
- Responsive design
- Card-based layout similar to ProverbsCard
- Form validation with error messages

### 5. Create MCP API Routes

**File: `src/app/api/mcp/route.ts`**

- `GET /api/mcp`: Retrieve current mcp.json
- `POST /api/mcp`: Create new server configuration
- `PUT /api/mcp`: Update existing server configuration
- `DELETE /api/mcp`: Remove server configuration
- File I/O operations to data/mcp.json
- JSON validation and error handling

**File: `src/app/api/mcp/test/route.ts`** (Optional)

- `POST /api/mcp/test`: Test MCP server connection
- Returns connection status and available tools

### 6. Add Navigation to Settings

**File: `src/app/layout.tsx`** or **`src/app/page.tsx`**

- Add settings button/link in UI
- Navigate to `/settings` route

### 7. Update Dependencies

**Backend: `agent/pyproject.toml`**

```toml
dependencies = [
    "uvicorn",
    "pydantic-ai-slim[ag-ui]",
    "pydantic-ai-slim[openai]",
    "pydantic-ai-slim[mcp]",
    "python-dotenv",
    "logfire>=4.10.0",
]
```

**Frontend: `package.json`** (if needed)

- No new frontend dependencies required

### 8. Testing Strategy

**Backend Tests:**

- Test MCP config loading with valid/invalid JSON
- Test server initialization with different configurations
- Test tool availability after loading
- Test error handling for missing files

**Frontend Tests:**

- Test CRUD operations through API
- Test form validation
- Test enable/disable toggle
- Test navigation to settings page

**Integration Tests:**

- End-to-end: Add MCP server → Save → Agent uses tool
- Test agent restart with persisted configuration
- Test with multiple MCP servers

### 9. Documentation

**Update README.md:**

- Add section on MCP tool integration
- Document mcp.json structure
- Provide example configurations
- List available MCP servers to try
- Troubleshooting guide

## Key Files to Create/Modify

### New Files

1. `data/mcp.json` - Configuration storage
2. `agent/src/mcp_loader.py` - MCP loading logic
3. `src/app/settings/page.tsx` - Settings UI
4. `src/app/api/mcp/route.ts` - API endpoints

### Modified Files

1. `agent/src/agent.py` - Add MCP tools to agent
2. `agent/pyproject.toml` - Add MCP dependencies
3. `src/lib/types.ts` - Add MCP types
4. `src/app/page.tsx` or `layout.tsx` - Add settings navigation

## Implementation Order

1. Create data structures and types (JSON schema, TypeScript types)
2. Implement MCP loader in Python backend
3. Update agent to use MCP tools
4. Create API routes for MCP configuration
5. Build settings page UI
6. Add navigation to settings
7. Test integration end-to-end
8. Update documentation

## Success Criteria

- ✅ Settings page allows adding/editing/deleting MCP servers
- ✅ Agent successfully loads and uses MCP tools
- ✅ Configuration persists across agent restarts
- ✅ UI shows real-time status of MCP servers
- ✅ Error handling for invalid configurations
- ✅ Documentation complete with examples

### To-dos

- [ ] Create mcp.json schema and TypeScript types for MCP configuration
- [ ] Build mcp_loader.py module to load and initialize MCP servers
- [ ] Update agent.py to integrate MCP tools into the agent's toolset
- [ ] Build API routes for CRUD operations on mcp.json
- [ ] Create settings page with UI for managing MCP configurations
- [ ] Add navigation link to settings page in main UI
- [ ] Test end-to-end MCP integration with example servers
- [ ] Document MCP integration in README with examples and troubleshooting