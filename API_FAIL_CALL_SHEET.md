# API Fail Call Sheet

## Overview

This document provides a comprehensive reference for API failure codes, error
handling, and troubleshooting procedures for the CopilotKit + LangGraph
application.

## Error Code Structure

Error codes follow the format: `[PREFIX][CATEGORY][NUMBER]`

- **Prefix**: API endpoint identifier

  - `COP` - CopilotKit API
  - `LGR` - LangGraph API
  - `MCP` - MCP Configuration API

- **Category**: Error type

  - `VAL` - Validation errors
  - `NET` - Network/external service errors
  - `SYS` - System/internal errors
  - `CFG` - Configuration errors
  - `AUTH` - Authentication errors
  - `AUTHZ` - Authorization errors
  - `BIZ` - Business logic errors
  - `EXT` - External service errors
  - `RATE` - Rate limiting errors

- **Number**: Sequential error number within category

## CopilotKit API Errors (COP)

### Validation Errors (VAL)

#### COP_VAL_001

- **Message**: Invalid message format
- **Status Code**: 400
- **Description**: The message content is not in the expected format
- **Troubleshooting**:
  - Ensure message is a valid object with content property
  - Check if message contains valid text or image content
  - Verify message structure matches CopilotKitMessage interface

#### COP_VAL_002

- **Message**: Missing required message content
- **Status Code**: 400
- **Description**: No message content provided in the request
- **Troubleshooting**:
  - Ensure request body contains a messages array
  - Check that messages array is not empty
  - Verify message objects have content property

### System Errors (SYS)

#### COP_SYS_001

- **Message**: Agent execution failed
- **Status Code**: 500
- **Description**: Failed to execute the LangGraph agent
- **Troubleshooting**:
  - Check agent graph configuration
  - Verify all agent dependencies are installed
  - Review agent logs for specific failure details

#### COP_SYS_002

- **Message**: Thread ID generation failed
- **Status Code**: 500
- **Description**: Unable to generate conversation thread ID
- **Troubleshooting**:
  - Check system entropy/random number generation
  - Verify timestamp generation is working
  - Ensure sufficient memory for string operations

### Network Errors (NET)

#### COP_NET_001

- **Message**: OpenAI API request failed
- **Status Code**: 502
- **Description**: Failed to communicate with OpenAI vision API
- **Troubleshooting**:
  - Check OpenAI API key configuration
  - Verify internet connectivity
  - Check OpenAI service status
  - Ensure API key has sufficient credits

#### COP_NET_002

- **Message**: Image URL inaccessible
- **Status Code**: 400
- **Description**: Unable to access the provided image URL
- **Troubleshooting**:
  - Verify image URL is publicly accessible
  - Check URL format and protocol (http/https)
  - Ensure image is not behind authentication
  - Check for CORS restrictions

### Business Logic Errors (BIZ)

#### COP_BIZ_001

- **Message**: Image analysis failed
- **Status Code**: 500
- **Description**: Failed to analyze trading screenshot
- **Troubleshooting**:
  - Ensure image contains trading chart data
  - Check image quality and resolution
  - Verify image format is supported
  - Try with a different image

## LangGraph API Errors (LGR)

### Validation Errors (VAL)

#### LGR_VAL_001

- **Message**: Message is required and must be a string
- **Status Code**: 400
- **Description**: The message parameter is missing or not a valid string
- **Troubleshooting**:
  - Ensure request body contains "message" field
  - Verify message is a non-empty string
  - Check JSON parsing is working correctly

#### LGR_VAL_002

- **Message**: Invalid thread ID format
- **Status Code**: 400
- **Description**: Thread ID provided is not in the expected format
- **Troubleshooting**:
  - Thread ID should be a string
  - Use previously returned thread IDs
  - Leave threadId empty for new conversations

### System Errors (SYS)

#### LGR_SYS_001

- **Message**: Agent graph invocation failed
- **Status Code**: 500
- **Description**: Failed to invoke the LangGraph agent graph
- **Troubleshooting**:
  - Check agent graph configuration
  - Verify agent dependencies are loaded
  - Review graph compilation errors
  - Check memory usage and limits

#### LGR_SYS_002

- **Message**: No response generated by agent
- **Status Code**: 500
- **Description**: Agent executed but produced no response messages
- **Troubleshooting**:
  - Check agent node implementations
  - Verify message routing in graph
  - Review agent prompt configuration
  - Check for infinite loops in agent logic

#### LGR_SYS_003

- **Message**: Message processing failed
- **Status Code**: 500
- **Description**: Failed to process or convert messages
- **Troubleshooting**:
  - Check message format compatibility
  - Verify message content types
  - Review message transformation logic

### Configuration Errors (CFG)

#### LGR_CFG_001

- **Message**: Invalid model configuration
- **Status Code**: 400
- **Description**: Model configuration provided is invalid
- **Troubleshooting**:
  - Check model provider is supported
  - Verify model name exists
  - Ensure temperature is between 0.0 and 1.0

### Network Errors (NET)

#### LGR_NET_001

- **Message**: External service communication failed
- **Status Code**: 502
- **Description**: Failed to communicate with external AI service
- **Troubleshooting**:
  - Check API key configuration
  - Verify internet connectivity
  - Check service availability
  - Review rate limiting status

## MCP API Errors (MCP)

### Validation Errors (VAL)

#### MCP_VAL_001

- **Message**: Server name and configuration are required
- **Status Code**: 400
- **Description**: Missing required fields for MCP server configuration
- **Troubleshooting**:
  - Provide both serverName and serverConfig
  - Ensure serverName is a non-empty string
  - Check serverConfig object structure

#### MCP_VAL_002

- **Message**: Command is required for server configuration
- **Status Code**: 400
- **Description**: MCP server configuration must include a command
- **Troubleshooting**:
  - Add command field to serverConfig
  - Ensure command points to executable
  - Check command path is correct

#### MCP_VAL_003

- **Message**: Server name is required
- **Status Code**: 400
- **Description**: Server name parameter is missing
- **Troubleshooting**:
  - Provide serverName in query parameters
  - Use correct parameter name (serverName)
  - Ensure serverName is URL encoded if needed

### Configuration Errors (CFG)

#### MCP_CFG_001

- **Message**: Failed to read MCP configuration
- **Status Code**: 500
- **Description**: Unable to read MCP configuration file
- **Troubleshooting**:
  - Check data/mcp.json file exists
  - Verify file permissions
  - Ensure JSON syntax is valid
  - Check file system access

#### MCP_CFG_002

- **Message**: Failed to write MCP configuration
- **Status Code**: 500
- **Description**: Unable to save MCP configuration changes
- **Troubleshooting**:
  - Check file system write permissions
  - Ensure data directory exists
  - Verify disk space availability
  - Check for file locks

#### MCP_CFG_003

- **Message**: Server already exists
- **Status Code**: 409
- **Description**: Cannot create server with existing name
- **Troubleshooting**:
  - Use a unique server name
  - Check existing servers first
  - Use PUT to update existing servers

#### MCP_CFG_004

- **Message**: Server not found
- **Status Code**: 404
- **Description**: Requested server does not exist
- **Troubleshooting**:
  - Check server name spelling
  - Verify server exists with GET request
  - Use correct case sensitivity

### System Errors (SYS)

#### MCP_SYS_001

- **Message**: Failed to create MCP server configuration
- **Status Code**: 500
- **Description**: Unexpected error during server creation
- **Troubleshooting**:
  - Check server logs for details
  - Verify server configuration format
  - Ensure all required fields are provided

#### MCP_SYS_002

- **Message**: Failed to update MCP server configuration
- **Status Code**: 500
- **Description**: Unexpected error during server update
- **Troubleshooting**:
  - Check server exists before updating
  - Verify configuration format
  - Check file system permissions

#### MCP_SYS_003

- **Message**: Failed to delete MCP server configuration
- **Status Code**: 500
- **Description**: Unexpected error during server deletion
- **Troubleshooting**:
  - Verify server exists
  - Check file system permissions
  - Ensure no processes are using the server

## Error Response Format

All API errors return a standardized response format:

```json
{
  "error": "Human-readable error message",
  "code": "ERROR_CODE",
  "statusCode": 400,
  "category": "VAL",
  "details": {
    // Additional error-specific details
  },
  "troubleshooting": [
    "Step 1: Check this",
    "Step 2: Verify that",
    "Step 3: Try this"
  ]
}
```

## Logging and Monitoring

### Console Logging

All API requests are logged with structured information including:

- Request ID for tracking
- API endpoint and method
- Request duration
- Response size
- Error codes and context

### Log Levels

- **INFO**: Normal operations, successful requests
- **WARN**: Warning conditions that don't prevent operation
- **ERROR**: Error conditions that prevent operation
- **DEBUG**: Detailed diagnostic information

### Log Format

```
ðŸš€ [API_NAME] REQUEST START: METHOD /path
ðŸš€ [API_NAME] Request ID: req_1234567890_abc123
âœ… [API_NAME] REQUEST SUCCESS: METHOD /path
âœ… [API_NAME] Duration: 150ms
âŒ [API_NAME] ERROR COP_VAL_001: Invalid message format
âŒ [API_NAME] Category: VAL
âŒ [API_NAME] Status Code: 400
```

## Common Troubleshooting Scenarios

### API Connection Issues

1. **Check Network Connectivity**

   - Verify internet connection
   - Check firewall settings
   - Confirm API endpoints are accessible

2. **Validate Request Format**

   - Ensure correct HTTP method
   - Check request headers (Content-Type: application/json)
   - Verify JSON syntax in request body

3. **Review Authentication**
   - Confirm API keys are set in environment
   - Check key validity and permissions
   - Verify key format and encoding

### Performance Issues

1. **Monitor Response Times**

   - Check for slow external API calls
   - Review database query performance
   - Monitor memory usage

2. **Check Rate Limits**
   - Review API quota usage
   - Implement request throttling if needed
   - Consider caching strategies

### Configuration Problems

1. **Environment Variables**

   - Verify all required env vars are set
   - Check variable naming and values
   - Restart services after env changes

2. **File Permissions**
   - Ensure config files are readable/writable
   - Check directory permissions
   - Verify file ownership

## Monitoring and Alerting

### Key Metrics to Monitor

- **Error Rate**: Percentage of requests returning errors
- **Response Time**: Average and 95th percentile response times
- **Throughput**: Requests per second
- **Error Distribution**: Most common error codes

### Alert Conditions

- Error rate > 5% for 5 minutes
- Response time > 10 seconds for 1 minute
- Specific error codes occurring frequently

## Development and Testing

### Testing Error Scenarios

1. **Unit Tests**

   - Test each error code path
   - Validate error response format
   - Check logging behavior

2. **Integration Tests**

   - Test end-to-end error handling
   - Verify error propagation
   - Check client error handling

3. **Load Testing**
   - Test error handling under load
   - Verify graceful degradation
   - Check resource limits

## Maintenance

### Regular Tasks

1. **Review Error Logs**

   - Analyze error patterns
   - Identify new error scenarios
   - Update troubleshooting guides

2. **Update Error Codes**

   - Add new error codes as needed
   - Deprecate unused codes
   - Maintain backward compatibility

3. **Performance Tuning**
   - Optimize slow error paths
   - Implement caching where appropriate
   - Monitor memory usage

---

## Quick Reference

### Most Common Errors

| Error Code  | Description            | Quick Fix                           |
| ----------- | ---------------------- | ----------------------------------- |
| COP_VAL_001 | Invalid message format | Check request structure             |
| LGR_VAL_001 | Missing message        | Add message field                   |
| MCP_VAL_001 | Missing server config  | Provide serverName and serverConfig |
| COP_NET_001 | OpenAI API failure     | Check API key and connectivity      |
| MCP_CFG_001 | Config file issues     | Check data/mcp.json permissions     |

### Error Code Ranges

- `VAL` codes (001-099): Input validation issues
- `NET` codes (001-099): Network and external service issues
- `SYS` codes (001-099): Internal system failures
- `CFG` codes (001-099): Configuration problems

This document is maintained alongside the codebase. Please update it when adding
new error codes or modifying error handling logic.
